<!-- ---
title: CTFer：第2章 web进阶
tags: 
      - 网络安全
      - Web 安全
categories: 
- [网络安全, CTF, 《从0到1：CTFer成长之路》]
- [网络安全, Web 安全]
--- -->

本章介绍4种利用技巧较为繁多、比赛出现频率较高的 Web 漏洞，分别是：SSRF漏洞、命令执行漏洞、XSS漏洞、文件上传漏洞。

<!--more-->

# 1. SSRF 漏洞
SSRF（Server Side Request Forgery，服务端请求伪造）是一种攻击者通过构造数据进而伪造服务器端发起请求的漏洞。因为请求是内部发起的，所以一般情况下 SSRF 漏洞攻击的目标往往是从外网无法访问的内部系统。

漏洞形成原因：服务端提供了从外部服务获取数据的功能，但没有对目标地址、协议等重要参数进行过滤和限制，从而攻击者可以自由构造参数，发起预期外的请求。

## 1.1 SSRF 的原理解析
URL 的结构如下：
> RUI = scheme:[//authority]path[?query][#fragment]


- scheme 由一串大小写不敏感的字符组成，表示获取资源所需要的协议
- authority 组件又分为：[userinfo@]host[:port]
  - userinfo 用的比较少，一般 HTTP 使用匿名形式来获取数据，如果需要进行身份验证，格式为 username:password，以 @ 结尾
  - host 表示服务器主机
  - post 表示服务器端口
  - path 为指向资源的路径
  - query 为查询字符串，以"?"作为表示
  - fragment 为片段 ID，与 query 不同，其内容不会传给服务器

假设存在一个图片的地址：`127.0.0.1:8233/?usr=https://www.baidu.com/img/bg_logo1.png`

如果获取图片的 url 参数未做任何过滤，攻击者可以通过修改该地址或协议来发起 SSRF 攻击，如修改为 `file:///etc/passwd`

## 1.2 SSRF 漏洞的寻找和测试
SSRF 漏洞一般出现在有调用外部资源的场景中，如社交服务分享功能、图片识别服务、网站采集服务、远程资源请求、文件处理服务等。在对存在SSRF漏洞的应用进行测试的时候，可以尝试是否能控制、支持常见的协议，包括但不限于以下协议。
- file://
- dict://字典服务器协议，让客户端能访问更多字典源。
- gopher://分布式文档传递服务。

## 1.3 SSRF 漏洞攻击方式
### 1.3.1 内部服务资源探测
SSRF 漏洞可以直接探测网站所在服务器端口的开放情况甚至内网资源情况。

### 1.3.2 使用 Gopher 协议扩展攻击面
1. 攻击 redis
   Redis 一般运行在内网，大多绑定于 127.0.0.1:6379。通过 SSRF 漏洞访问内网 Redis
2. 攻击 MySQL
   MySQL 客户端连接服务器有4种方式：UNIX 套接字、内存共享、命名管道、TCP/IP 套接字
   攻击一般依靠第4种方式
3. PHP-FPM 攻击
   利用条件：Libcurl > 7.45.0；PHP-FPM > 5.3.3；知道服务器上任意一个 PHP 文件的绝对路径。